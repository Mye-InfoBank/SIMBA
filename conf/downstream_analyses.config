singularity.runOptions = "--env MKL_NUM_THREADS=1,OPENBLAS_NUM_THREADS=1,OMP_NUM_THREADS=1"

process {

    /***************************************************
     * Add additional datasets
     ***************************************************/

    withName: SCQC {
        container = "${baseDir}/containers/scqc.sif"
        publishDir = [
            path: { "${params.outdir}/01_qc_and_filtering/${meta.id}" },
            mode: params.publish_dir_mode
        ]
    }
    withName: SCQC_MERGE_STATS {
        publishDir = [
            path: "${params.outdir}/01_qc_and_filtering",
            mode: params.publish_dir_mode
        ]
    }
    withName: INTEGRATE_INTO_ATLAS {
        cpus = 2
        containerOptions = "--nv --no-home"
        clusterOptions = '-V -S /bin/bash -q all.q@apollo-15'
        conda = "/home/sturm/.conda/envs/pircher-sc-integrate2"
        publishDir = [
            path: { "${params.outdir}/02_integrate_into_atlas/${parameters.dataset_id}" },
            mode: params.publish_dir_mode
        ]
        ext.kernel = "python3"
        cache = 'lenient'
    }
    withName: UPDATE_ANNOTATION {
        cpus = 16
        conda = "/home/sturm/.conda/envs/pircher-sc-integrate2"
        publishDir = [
            path: "${params.outdir}/03_update_annotation",
            mode: params.publish_dir_mode
        ]
        ext.kernel = "python3"
        cache = 'lenient'
    }

    /***************************************************
     * Notebooks
     ***************************************************/

    withName: NEUTROPHIL_SUBCLUSTERING {
        conda = "/home/sturm/.conda/envs/pircher-sc-integrate2"
        // container = "${baseDir}/containers/pircher-sc-integrate2_2021-11-27_patched_annotation_helper.sif"
        publishDir = [
            path: "${params.outdir}/04_neutrophil_subclustering",
            mode: params.publish_dir_mode
        ]
        ext.kernel = "python3"
        cache = 'lenient'
    }

    withName: STRATIFY_PATIENTS {
        conda = "/home/sturm/.conda/envs/pircher-sc-integrate2"
        // container = "${baseDir}/containers/pircher-sc-integrate2_2021-11-27_patched_annotation_helper.sif"
        publishDir = [
            path: "${params.outdir}/stratify_patients",
            mode: params.publish_dir_mode
        ]
        ext.kernel = "python3"
        cache = 'lenient'
    }

    /***************************************************
     * SCISSOR
     ***************************************************/

    withName: ".*scissor:SPLIT_ANNDATA" {
        publishDir = [
            path: "${params.outdir}/scissor/adata_by_patient",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*scissor:H5AD_TO_SCE" {
        publishDir = [
            path: "${params.outdir}/scissor/adata_by_patient",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*scissor:SCISSOR" {
        // errorStrategy = 'ignore'
        ext.ignore_error = true
        // container = "${baseDir}/containers/2020-pircher-scissor_2022-03-09.sif"
        conda = "/data/scratch/sturm/conda/envs/2020-pircher-scissor"
        publishDir = [
            path: { "${params.outdir}/scissor/scissor_by_sample/${id}" },
            mode: params.publish_dir_mode
        ]
    }


    /***************************************************
     * DE analysis
     ***************************************************/

    withName: ".*de_analysis.*:DE_DESEQ2" {
        errorStrategy = "ignore"
    }
    withName: ".*de_analysis:PREPARE_FOR_DE" {
        ext.kernel = "python3"
        container = "${baseDir}/containers/pircher-sc-integrate2_2021-11-27_patched_annotation_helper.sif"
        publishDir = [
            path: "${params.outdir}/de_analysis/prepare_for_de",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_tumor_normal:SPLIT_ANNDATA" {
        publishDir = [
            path: "${params.outdir}/de_analysis/tumor_normal/adata_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_tumor_normal:MAKE_PSEUDOBULK" {
        publishDir = [
            path: "${params.outdir}/de_analysis/tumor_normal/pseudobulk_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_tumor_normal:DE_DESEQ2" {
        publishDir = [
            path: "${params.outdir}/de_analysis/tumor_normal/de_deseq2",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_luad_lusc:SPLIT_ANNDATA" {
        publishDir = [
            path: "${params.outdir}/de_analysis/luad_lusc/adata_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_luad_lusc:MAKE_PSEUDOBULK" {
        publishDir = [
            path: "${params.outdir}/de_analysis/luad_lusc/pseudobulk_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_luad_lusc:DE_DESEQ2" {
        publishDir = [
            path: "${params.outdir}/de_analysis/luad_lusc/de_deseq2",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_early_advanced:SPLIT_ANNDATA" {
        publishDir = [
            path: "${params.outdir}/de_analysis/early_advanced/adata_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_early_advanced:MAKE_PSEUDOBULK" {
        publishDir = [
            path: "${params.outdir}/de_analysis/early_advanced/pseudobulk_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_early_advanced:DE_DESEQ2" {
        publishDir = [
            path: "${params.outdir}/de_analysis/early_advanced/de_deseq2",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_b_desert:SPLIT_ANNDATA" {
        publishDir = [
            path: "${params.outdir}/de_analysis/b_desert/adata_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_b_desert:MAKE_PSEUDOBULK" {
        publishDir = [
            path: "${params.outdir}/de_analysis/b_desert/pseudobulk_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_b_desert:DE_DESEQ2" {
        publishDir = [
            path: "${params.outdir}/de_analysis/b_desert/de_deseq2",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_t_desert:SPLIT_ANNDATA" {
        publishDir = [
            path: "${params.outdir}/de_analysis/t_desert/adata_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_t_desert:MAKE_PSEUDOBULK" {
        publishDir = [
            path: "${params.outdir}/de_analysis/t_desert/pseudobulk_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_t_desert:DE_DESEQ2" {
        publishDir = [
            path: "${params.outdir}/de_analysis/t_desert/de_deseq2",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_m_desert:SPLIT_ANNDATA" {
        publishDir = [
            path: "${params.outdir}/de_analysis/m_desert/adata_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_m_desert:MAKE_PSEUDOBULK" {
        publishDir = [
            path: "${params.outdir}/de_analysis/m_desert/pseudobulk_by_cell_type",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*de_analysis_m_desert:DE_DESEQ2" {
        publishDir = [
            path: "${params.outdir}/de_analysis/m_desert/de_deseq2",
            mode: params.publish_dir_mode
        ]
    }



    /****************************************************
     * Squidpy
     ****************************************************/

    withName: ".*cell2cell_major:SPLIT_ANNDATA" {
        publishDir = [
            path: "${params.outdir}/cell2cell_major/adata_by_sample",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*cell2cell_major:SQUIDPY" {
        // errorStrategy = 'ignore'
        ext.ignore_error = false
        conda = "/data/scratch/sturm/conda/envs/2020-pircher-squidpy"
        // container = "${baseDir}/containers/2020-pircher-squidpy_2022-03-09.sif"
        publishDir = [
            path: { "${params.outdir}/cell2cell_major/squidpy/${id}" },
            mode: params.publish_dir_mode
        ]
        cpus = 2
    }
    withName: ".*cell2cell_major:MAKE_CPDB_H5AD" {
        // conda = "/home/sturm/.conda/envs/pircher-sc-integrate2"
        container = "${baseDir}/containers/pircher-sc-integrate2_2021-11-27_patched_annotation_helper.sif"
        publishDir = [
            path: "${params.outdir}/cell2cell_major/cpdb_h5ad",
            mode: params.publish_dir_mode
        ]
        ext.kernel = "python3"
    }

    withName: ".*cell2cell_neutro:SPLIT_ANNDATA" {
        publishDir = [
            path: "${params.outdir}/cell2cell_neutro/adata_by_sample",
            mode: params.publish_dir_mode
        ]
    }
    withName: ".*cell2cell_neutro:SQUIDPY" {
        // errorStrategy = 'ignore'
        ext.ignore_error = false
        conda = "/data/scratch/sturm/conda/envs/2020-pircher-squidpy"
        // container = "${baseDir}/containers/2020-pircher-squidpy_2022-03-09.sif"
        publishDir = [
            path: { "${params.outdir}/cell2cell_neutro/squidpy/${id}" },
            mode: params.publish_dir_mode
        ]
        cpus = 2
    }
    withName: ".*cell2cell_neutro:MAKE_CPDB_H5AD" {
        // conda = "/home/sturm/.conda/envs/pircher-sc-integrate2"
        container = "${baseDir}/containers/pircher-sc-integrate2_2021-11-27_patched_annotation_helper.sif"
        publishDir = [
            path: "${params.outdir}/cell2cell_neutro/cpdb_h5ad",
            mode: params.publish_dir_mode
        ]
        ext.kernel = "python3"
    }


    /*************************************************
     * infercnv
     *************************************************/
    withName: ".*infercnv:RUN_SCEVAN" {
        ext.ignore_error = true
        publishDir = [
            path: { "${params.outdir}/infercnv/scevan/${id}" },
            mode: params.publish_dir_mode
        ]
        // container = "${baseDir}/containers/panizzolo_scevan_2022-03-09.sif"
        conda = '/home/panizzolo/.conda/envs/r_env'
        cpus = 4
    }
    withName: ".*infercnv:RUN_INFERCNVPY" {
        ext.ignore_error = true
        publishDir = [
            path: { "${params.outdir}/infercnv/infercnvpy/${id}" },
            mode: params.publish_dir_mode
        ]
        // container = "${baseDir}/containers/panizzolo_infercnv2_2022-03-09.sif"
        conda = '/home/panizzolo/.conda/envs/infercnv2'
        cpus = 1
    }

    /*************************************************
     * plots and comparisons
     *************************************************/
    withName: ".*plots_and_comparisons:COMPARE_GROUPS" {
        conda = "/home/sturm/.conda/envs/pircher-sc-integrate2"
        // container = "${baseDir}/containers/pircher-sc-integrate2_2021-11-27_patched_annotation_helper.sif"
        publishDir = [
            path: "${params.outdir}/plots_and_comparisons/91_compare_groups",
            mode: params.publish_dir_mode
        ]
        ext.kernel = "python3"
        cpus = 11
    }

    withName: ".*plots_and_comparisons:SCCODA" {
        conda = "/home/sturm/.conda/envs/pircher-sc-integrate2"
        // container = "${baseDir}/containers/pircher-sc-integrate2_2021-11-27_patched_annotation_helper.sif"
        publishDir = [
            path: { "${params.outdir}/plots_and_comparisons/98_cell_type_composition/${ meta.id }" },
            mode: params.publish_dir_mode
        ]
        ext.kernel = "python3"
        // tensorflow uses ~340% cpu
        cpus = 4
    }
}

