---
output: html_document
params:
  cpus: 1
  artifact_dir: "/data/scratch/sturm/tmp"
  meta: NULL
  ici_tpm: "../../data/14_ici_treatment/Genentech_for_scissor/genentech.rds"
  ici_meta: "../../data/14_ici_treatment/Genentech_for_scissor/genentech_clinical_data.tsv"
  # neutro_sigs: "../../data/30_downstream_analyses/neutrophils/neutrophil_analysis/artifacts/neutro_sigs.csv"
  neutro_sigs: "/home/sturm/Downloads/neutro_sigs.csv"
  net_sigs: "../../tables/gene_annotations/net_signatures.csv"
  input_dir: NULL
---

```{r}
library(conflicted)
library(dplyr)
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
conflict_prefer("rename", "dplyr")
library(survminer)
library(survival)
library(tidyr)
library(readr)
library(stringr)
library(tibble)
library(ggbeeswarm)
library(cowplot)
library(readxl)
```

# Load data

## ICI

```{r}
ici_tpm = read_rds(params$ici_tpm)
ici_meta = read_tsv(params$ici_meta) |> rename(dataset=study)
```

## TCGA

```{r}
tcga_clinical_data = read_tsv("../../tables/tcga/clinical_data_for_scissor.tsv")
tcga_tpm = read_rds("../../data/13_tcga/for_scissor/nsclc_primary_tumor.rds")
tcga_age = suppressWarnings(read_excel("../../tables/tcga/mmc1.xlsx") %>% select(TCGA_patient_barcode=bcr_patient_barcode, age=age_at_initial_pathologic_diagnosis))
tcga_treatment = read_tsv("../../tables/tcga/tcga_treatment.tsv")
```

```{r}
# TODO move to other notebook
tcga_patient_stratification = read_rds("../../tables/tcga/quantiseq_patient_stratification.rds")
tcga_patient_stratification = data.frame(patient_strat = tcga_patient_stratification) |> as_tibble(rownames="TCGA_patient_barcode") |> mutate(TCGA_patient_barcode = TCGA_patient_barcode |> str_replace_all(".*TCGA\\.(.{2})\\.(.{4}).*", "TCGA-\\1-\\2"))
```

## Signatures 

```{r}
neutro_sig_tab = read_csv(params$neutro_sigs)
net_sig_tab = read_csv(params$net_sigs, comment="#")
net_sig = sapply(unique(net_sig_tab$signature), function(sig) { net_sig_tab |> filter(signature == !!sig) |> pull(gene_symbol)}, USE.NAMES = TRUE, simplify = FALSE)
neutro_sig = sapply(unique(neutro_sig_tab$signature), function(sig) { neutro_sig_tab |> filter(signature == !!sig) |> pull(gene_symbol)}, USE.NAMES = TRUE, simplify = FALSE)
```

```{r}
all_sigs = c(neutro_sig, net_sig)
sig_names = names(all_sigs)
sig_names = c(sig_names, "sig_trn_mean")
```

# Functions to compute signature scores

## Original LCAM scores
This essentially computes a mean z score of marker gene expression. 
However, scores for each cell-type are computed separately, and then averaged. 

There's a LCAMhi and LCAMlo signature. Finally, a "LCAM consensus" signature 
is created, but subtracting one from the other. That way, the authors claim,
they generate a score that's independent of overall immune infiltration. 
```{r}
# From https://github.com/effiken/Leader_et_al/blob/3eb043acdea7b3dea45a2325ee1035060d9964af/scripts/get_LCAM_scores.R
library(matrixStats)

LCAMhi_subtypes <- c("IgG_plasma","SPP1_mac","T_activated")
LCAMlo_subtypes <- c("B","AM","cDC2","AZU1_mac","cDC1")
genes <- strsplit("IGHG3,IGHG4,IGHG1,MZB1,FAM92B,SPAG4,DERL3,JSRP1,TBCEL,LINC01485,SLC2A5,SPP1,CCL7,HAMP,CXCL13,ZBED2,GNG4,KRT86,TNFRSF9,LAYN,GZMB,KIR2DL4,GAPT,CTB-133G6.1,AKR1C3,RSPO3,MCEMP1,RND3,HP,FOLR3,GPD1,GS1-600G8.5,PCOLCE2,CAMP,CCL17,CD1B,CD1C,CD1E,PLD4,TRPC6,CLEC10A,FCER1A,PLA1A,CFP,CEACAM8,AZU1,PKP2,RETN,LYZ,ELANE,ATP6AP1L,RP6-159A1.4,THBS1,CFD,P2RY14,DNASE1L3,PTGER3,CST3,BATF3,CPVL,RGS18,SERPINF2,LGALS2",",")[[1]]
subtypes <- rep(c(LCAMhi_subtypes,LCAMlo_subtypes),times=c(10,4,8,2,10,10,10,9))
names(subtypes) <- genes


get_LCAM_scores <- function(expr_mat){
  
  message("computing LCAM scores on bulkRNA expression matrix")
  # identify matching gene symbols
  genes_matching <- intersect(genes,rownames(expr_mat))
  subtypes_matching <- subtypes[genes_matching]
  missing_genes <- setdiff(genes,genes_matching)
  if(!is.null(missing_genes)){
    message(paste("inconsistent gene symbols:",paste(missing_genes,collapse=", ")))
  }
  
  # normalize and scale expression values
  expr_mat <- t(t(expr_mat)/rowSums(t(expr_mat)))
  zmat <- t(scale(t(log10(1e-6+expr_mat[genes_matching,]))))
  
  #subset expression matrix to only the genes needed for the scores
  #zmat <- zmat[genes_matching,]
  
  # compute subtype scores
  score_mat <- matrix(0,nrow=length(genes_matching),ncol=length(unique(subtypes_matching)),dimnames=list(genes_matching,unique(subtypes_matching)))
  for(subtype_iter in subtypes_matching){
    score_mat[genes_matching[subtypes_matching==subtype_iter],subtype_iter] <- 1
  }
  
  subtype_scores <- t(scale(t(t(score_mat)%*%zmat)))
  
  #summarize the subtype scores
  res <- cbind(colMeans(subtype_scores[LCAMhi_subtypes,]),colMeans(subtype_scores[LCAMlo_subtypes,]))
  res <- cbind(res,res[,1]-res[,2])
  colnames(res) <- c("LCAMhi","LCAMlo","difference")
  return(res)

}
```

## "Mean z score" scoring function
This is similar to the LCAM score, just there is no differentiation between markers for different cell-types. 
```{r}
norm01 = function(x)  (x-min(x))/(max(x)-min(x))

#' Score signature genes as described in the Merad paper
#' 
#' This is a simple mean of the z-scored gene expression
get_lcam_scores = function(mixture, genes) {
  exclude_genes = setdiff(genes, rownames(mixture))
  if(length(exclude_genes)) {
    warning(sprintf("Excluded the following genes which are not in the mixture matrix: %s", paste(exclude_genes, collapse=", ")))
    genes = setdiff(genes, exclude_genes)
  }
  signature_expression = t(scale(t(log1p(mixture[genes, ,drop=FALSE]))))
  apply(signature_expression, MARGIN = 2, mean, na.rm=TRUE)
}

scoring_function = get_lcam_scores 
```

## Significance codes
```{r}
sig_codes = Vectorize(function(p) {
  if(p < 0.001) {
    "p < 0.001"
  } else if(p < 0.01) {
    "p < 0.01"
  } else if (p < 0.05) {
    "p < 0.05"
  } else if (p < 0.1) {
    "p < 0.1"
  } else {
    "p >= 0.1"
  }
})
```


# Prepare data
## ICI treatment data

```{r, fig.width=12, fig.height=7}

ici_lcam_scores = get_LCAM_scores(ici_tpm)


ici_scores = data.frame(sapply(names(all_sigs), function(sig) {
  scoring_function(ici_tpm, all_sigs[[sig]])
})) |> mutate(
    sig_lcam_hi=ici_lcam_scores[, 1],
    sig_lcam_lo=ici_lcam_scores[, 2],
    sig_lcam_consensus=ici_lcam_scores[, 3],
    sig_trn_mean=(sig_tan+sig_nan)/2
) |> 
  as_tibble(rownames="sample")

ici_clin_and_scores = ici_meta |> 
  rename(sample=sample_id) |>
  inner_join(ici_scores) |>
  mutate(response_to_any = ifelse(study_arm == "Docetaxel", response_to_chemotherapy, response_to_ici), .before="response_to_chemotherapy") |>
  mutate_at(vars(type, dataset, study_arm, response_to_chemotherapy, response_to_ici, response_to_any), factor)

```

## TCGA data

```{r}
tcga_lcam_scores = get_LCAM_scores(tcga_tpm)

tcga_scores = data.frame(sapply(names(all_sigs), function(sig) {
  scoring_function(tcga_tpm, all_sigs[[sig]])
})) |> mutate( 
  sig_lcam_hi=tcga_lcam_scores[, 1],
  sig_lcam_lo=tcga_lcam_scores[, 2],
  sig_lcam_consensus=tcga_lcam_scores[, 3],
  sig_trn_mean=(sig_tan+sig_nan)/2
) |> 
  as_tibble(rownames="TCGA_patient_barcode")

selected_treatments = tcga_treatment |> 
  filter(tumor %in% c("LUAD", "LUSC"), !is.na(bcr_drug_barcode)) |>
  select(drug_name, measure_of_response, type=tumor, patient_barcode, therapy_type, treatment_n) |>
  filter(treatment_n == 1) |> # only 1st line 
  mutate(TCGA_patient_barcode = str_to_upper(patient_barcode)) |> 
  filter(therapy_type == "chemotherapy", !is.na(measure_of_response))

tcga_clin_and_scores = tcga_clinical_data %>% 
  left_join(tcga_age) |>
  inner_join(tcga_scores) |>
  left_join(selected_treatments) |> 
  left_join(tcga_patient_stratification) |>
  mutate_at(vars(type, ajcc_pathologic_tumor_stage, gender, tumor_stage_ajcc, patient_strat), factor)
```


```{r}
all_datasets = list("ICI"=ici_clin_and_scores, "TCGA"=tcga_clin_and_scores)
```

# LUAD vs LUSC

```{r, fig.width=12, fig.height=5}
lapply(names(all_datasets), function(dataset) {
  all_datasets[[dataset]] |> select(type, starts_with("sig_")) |>
    filter(!is.na(type)) |> 
    pivot_longer(-type, names_to="signature", values_to="score") |>
    ggplot(aes(x=signature, y=score, color=type)) + 
    theme_cowplot() + 
    background_grid() + 
    geom_boxplot() + 
    ggtitle(dataset) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
})

```

```{r}
# ICI
lapply(sig_names, function(sig) {
  res = summary(lm(as.formula(sprintf("`%s` ~ type + dataset + gender + study_arm", sig)), data=ici_clin_and_scores))
  res$coefficients |> as_tibble(rownames="var") |> mutate(sig=sig, .before=1)
}) |> bind_rows() |> filter(var == "typeLUSC")

# TCGA
lapply(sig_names, function(sig) {
  res = summary(lm(as.formula(sprintf("`%s` ~ type + gender + age + tumor_stage_ajcc", sig)), data=tcga_clin_and_scores))
  res$coefficients |> as_tibble(rownames="var") |> mutate(sig=sig, .before=1)
}) |> bind_rows() |> arrange(var, sig) |> filter(var == "typeLUSC")
```

---

## Survival analysis with interaction terms

This should answer the question if there's a different effect of Neutrophils
in the different treatment arms

```{r}
res = summary(coxph(as.formula("Surv(time, status) ~ sig_neutro_balanced * study_arm + dataset + gender"), data = ici_clin_and_scores |> filter(type == "LUSC")))
res
```

```{r}
res = summary(coxph(as.formula("Surv(time, status) ~ dataset + type + sig_neutro_balanced_fc * study_arm + gender"), data = ici_clin_and_scores))
res
```

## Response analysis with interaction terms


```{r}
summary(glm(as.formula("response_to_any ~ dataset + sig_neutro_balanced * study_arm + gender"), data=ici_clin_and_scores |> filter(!is.na(response_to_any), type == "LUAD"), family="binomial"))
```
```{r}
summary(glm(as.formula("response_to_any ~ sig_tan * type + dataset + sig_tan * study_arm"), data=ici_clin_and_scores |> filter(!is.na(response_to_any)), family="binomial"))
```


## Survival analysis

```{r, fig.width=6, fig.height=6}
tmp_sig_names = sig_names
tmp_sig_names = c("sig_tan_functional_program", "sig_nan_functional_program", "sig_tan", "sig_nan", "sig_neutro_balanced_fc", "sig_trn")
coxph_results = lapply(c("any", "Docetaxel", "MPDL3280A"), function(arm) {
    lapply(c("all", "LUSC", "LUAD"), function(type) {
        filter_type = if(type == "all") {c("LUAD", "LUSC") } else {type}
        filter_arm = if(arm == "any") {c("Docetaxel", "MPDL3280A")} else {arm}
        type_covar = ifelse(type == "all", "+ type ", "")
        arm_covar = ifelse(arm == "any", "+ study_arm", "")
        coxph_res = lapply(tmp_sig_names, function(col) {
           res = summary(coxph(as.formula(sprintf("Surv(time, status) ~ `%s` %s %s + dataset", col, type_covar, arm_covar)), data=ici_clin_and_scores |> 
                                 filter(type %in% filter_type, study_arm %in% filter_arm)))
           res$coefficients |> 
             as_tibble(rownames="var") |> 
             filter(grepl( col, var)) |> 
             mutate(var=col, type=type)
           
        }) |> bind_rows() |> mutate(sig_code = sig_codes(`Pr(>|z|)`)) |> 
          # arrange(-coef) |> 
          mutate(var=factor(var, levels=unique(var)))
        
        print(coxph_res |> ggplot(aes(x=var, y=coef)) +
                geom_bar(aes(fill=sig_code), stat="identity", color="black") + 
                scale_fill_brewer(palette= "Blues", direction=-1) + 
                theme_cowplot()+ 
                theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
                geom_hline(yintercept = 0, color="black") +
                facet_wrap(~type, ncol=1)+ 
                ggtitle(sprintf("Study arm: %s", arm)))
        
        ggsave2(sprintf("/home/sturm/Downloads/coxph_%s_%s.pdf", arm, type))
        
        coxph_res |> mutate(type=type)
    }) |> bind_rows() |> mutate(study_arm=arm)
}) |> bind_rows()

```


```{r, fig.width=4, fig.height=4}
plot_kaplan_meyer = function(clinical_data, column, q=c(0.25, .75), pvalue=TRUE) {
  tmp_col = clinical_data[[column]]
  cutoffs = quantile(tmp_col, q)
  group = rep(NA, length(tmp_col))
  group[tmp_col < cutoffs[1]] = "bottom 25%"
  group[tmp_col > cutoffs[2]] = "top 25%"
  clinical_data$group = group
  clinical_data = clinical_data |> filter(time < 365 * 5)
  fit = survfit(Surv(time, status) ~ group, data=clinical_data)
  ggsurvplot(fit, data=clinical_data, pval=pvalue, risk.table = FALSE, xlab="time in days")
}

lapply(c("any", "Docetaxel", "MPDL3280A"), function(arm) {
    lapply(c("LUAD", "LUSC", "all"), function(type) {
        filter_type = if(type == "all") {c("LUAD", "LUSC") } else {type}
        filter_arm = if(arm == "any") {c("Docetaxel", "MPDL3280A")} else {arm}
        lapply(c("sig_tan", "sig_nan"), function(sig) {
          p = plot_kaplan_meyer(
            ici_clin_and_scores |> filter(type %in% filter_type, study_arm %in% filter_arm),
            sig,
            pvalue=sprintf("p=%*.3f, CoxPH reg.", 3, coxph_results |> filter(var == sig, type == !!type, study_arm == arm) |> pull(`Pr(>|z|)`)),
          ) + 
            ggtitle(sprintf("%s (%s, %s)", sig, type, arm))
          ggsave(file.path(params$artifact_dir, sprintf("KM_%s_%s_%s.pdf", sig, type, arm)), width=4.5, height=4)
          p
        })
    })
})
```
### Multi-KM plot

Neutro-lo Neutro-hi + study arms in same plot. 
```{r, fig.width=8, fig.height=4}
plot_kaplan_meyer_multi = function(clinical_data, column, q=c(0.25, .75), pvalue=TRUE, ...) {
  tmp_col = clinical_data[[column]]
  cutoffs = quantile(tmp_col, q)
  group = rep(NA, length(tmp_col))
  group[tmp_col < cutoffs[1]] = "bottom 25%"
  group[tmp_col > cutoffs[2]] = "top 25%"
  clinical_data$group = group
  # clinical_data = clinical_data |> filter(time < 365 * 5) |>
    # mutate(group_multi = sprintf("%s %s"))
  fit = survfit(Surv(time, status) ~ group + study_arm, data=clinical_data)
  ggsurvplot(fit, data=clinical_data, pval=pvalue, risk.table = FALSE, xlab="time in days",legend="right", ...)
}

lapply(c("sig_neutro_balanced", "sig_tan", "sig_nan", "sig_neutro_balanced_fc", "sig_trn"), function(sig) {
  lapply(c("all", "LUAD", "LUSC"), function(tmp_type) {
    if(tmp_type == "all") {
      filter_type = c("LUAD", "LUSC")
    } else {
      filter_type = tmp_type
    }
    plot_kaplan_meyer_multi(ici_clin_and_scores |> filter(type %in% filter_type), sig, title=sprintf("%s (%s)", sig, tmp_type))
  })
})

```

## Responder vs. Non-responder

### Response to ICI
```{r, fig.width=6, fig.height=6}
tmp_sig_names = sig_names
tmp_sig_names = c("sig_tan_functional_program", "sig_nan_functional_program", "sig_tan", "sig_nan", "sig_neutro_balanced_fc", "sig_trn")
ici_data = ici_clin_and_scores
glm_res = lapply(c("any", "Docetaxel", "MPDL3280A"), function(arm) {
  lapply(c("all", "LUSC", "LUAD"), function(type) {
      filter_arm = if(arm == "any") {c("Docetaxel", "MPDL3280A")} else {arm}
      filter_type = if(type == "all") {c("LUAD", "LUSC") } else {type}
      type_covar = ifelse(type == "all", "+ type ", "")
      tmp_res = lapply(tmp_sig_names, function(col) {
        res = summary(glm(as.formula(sprintf("response_to_any ~ `%s` %s + dataset", col, type_covar)), family="binomial", data=ici_data |> filter(type %in% filter_type, study_arm %in% filter_arm)))
        res$coefficients |> as_tibble(rownames="var") |> filter(grepl( col, var)) |> mutate(var=col)
      }) |> 
        bind_rows() |> 
        mutate(sig_code = sig_codes(`Pr(>|z|)`)) |>
        # arrange(-Estimate) |> 
        mutate(var=factor(var, levels=unique(var)))
      
      tmp_res = tmp_res |> mutate(type=type, arm=arm)
      print(tmp_res |> ggplot(aes(x=var, y=Estimate)) + 
              geom_bar(aes(fill=sig_code), stat="identity") +
              scale_fill_brewer(palette= "Blues", direction=-1)  + 
              theme_cowplot()+
              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
              geom_hline(yintercept = 0, color="black") + 
              ggtitle(sprintf("Study arm: %s", arm)) +
              facet_wrap(~type, ncol=1))
      
      tmp_res
      
  }) |> bind_rows()
}) |> bind_rows()
```

```{r, fig.width=18, fig.height=7}
pvalue_df = glm_res |> filter(`Pr(>|z|)` < 1, type == "all", arm=="MPDL3280A") |> 
  select(signature=var, pvalue=`Pr(>|z|)`) |> 
  mutate(pvalue = sprintf("p=%*.3f", 3, pvalue)) |>
  distinct()

p = ici_data |> select(type, response=response_to_ici, dataset, starts_with("sig_")) |>
    pivot_longer(-c(type, response, dataset), names_to="signature", values_to="score") |>
    filter(!is.na(response)) |> 
    inner_join(pvalue_df) |> 
    ggplot(aes(x=response, y=score)) + 
    geom_quasirandom(aes(color=type, shape=dataset)) +
    geom_boxplot(outlier.alpha=0, width=.2) + 
    geom_text(aes(label = pvalue), x=-Inf, y=Inf, data=pvalue_df, hjust = -0.2, vjust=1) +
    theme_cowplot() + 
    background_grid() + 
    facet_wrap(~signature, ncol = 7, scales="free_y") + 
    ggtitle(sprintf("Scoring function: %s", params$scoring_function)) + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggsave(file.path(params$artifact_dir, "ici_treatment_response.pdf"), width = 18, height=7)
p
```

```{r}
ici_clin_and_scores |> filter(!is.na(response_to_ici)) |> 
  ggplot(aes(y=sig_lcam_consensus, x=sig_neutro_top_0)) + geom_smooth(method="lm", color="black") + geom_point(aes(color=response_to_ici)) + stat_cor() + theme_cowplot() + background_grid() + scale_color_brewer(palette="Dark2")
ggsave(file.path(params$artifact_dir, "corr_lcam_consensus_vs_neutro2.pdf"), width=6, height=4)
```


---

## patient stratification

```{r}
tcga_patient_strat_didi = read_tsv("../../tables/tcga/quantiseq_patient_stratification_didi.tsv") |> rename(patient_strat_didi = patient_strat)
tcga_clin_and_scores = tcga_clin_and_scores |> left_join(tcga_patient_strat_didi)
```

```{r}
deconv_res = read_tsv("../../data/13_tcga/immunedeconv/nsclc_deconvolution.tsv")
```

```{r}
cell_type_group = c("uncharacterized cell" = "desert", "Macrophage M1" = "M", "Macrophage M2"="M", "T cell regulatory (Tregs)"="T", "B cell"= "B", "T cell CD8+"= "T", "T cell CD4+ (non-regulatory)" = "T", "Monocyte" = "M")
```

```{r}
summary(coxph(as.formula("Surv(time, status) ~ patient_strat_didi + age + gender"), data=tcga_clin_and_scores))
```

```{r}
summary(glm(as.formula("response_to_chemotherapy ~ patient_strat_didi"), family="binomial", data=tcga_clin_and_scores))
```

```{r}
fit = survfit(Surv(time, status) ~ patient_strat_didi, data=tcga_clin_and_scores |> filter(time < 365 * 5))
ggsurvplot(fit, data=tcga_clin_and_scores)
```

```{r}
tmp_check = deconv_res |> pivot_longer(-c(cell_type, method), names_to="TCGA_patient_barcode", values_to="score") |> filter(method == "quantiseq") |> inner_join(tcga_patient_strat_didi)
```

```{r, fig.width=10, fig.height=10}
tmp_check |> ggplot(aes(x=patient_strat_didi, y=score)) + geom_boxplot() + facet_wrap(~cell_type, scale="free_y")
```

---