---
output: html_document
params:
  survival_path: "../../tables/mmc1.xlsx"
  tcga_tpm_path: "../../data/13_tcga/tcga-lung-primary.rds"  
  cpus: 1
  id: test
  artifact_dir: "/data/scratch/sturm/tmp"
  meta: NULL
  input_dir: NULL
---

```{r}
library(conflicted)
library(dplyr)
conflict_prefer("filter", "dplyr")
library(readxl)
library(survminer)
library(survival)
library(tidyr)
library(readr)
library(stringr)
```

```{r}
# # TODO test/train split, put into separate script
# lusc = read_tsv("../../data/13_tcga/TCGA-LUSC-SolidTissueNormal-TPM.txt.gz")
# luad = read_tsv("../../data/13_tcga/TCGA-LUAD-SolidTissueNormal-TPM.txt.gz")
# tcga_lung = luad %>%
#   inner_join(lusc, by=c("ENSGID", "GeneName")) %>%
#   select(-ENSGID) %>%
#   group_by(GeneName) %>%
#   summarise_all(sum) %>%
#   tibble::column_to_rownames("GeneName") %>%
#   as.matrix()
# 
# colnames_new = sapply(colnames(tcga_lung), function(x) {paste(str_split(x, pattern="-")[[1]][1:3], collapse="-")}, USE.NAMES = FALSE)
# colnames(tcga_lung) = colnames_new
# 
# # for now, exclude duplicates
# tcga_lung = tcga_lung[, !duplicated(colnames(tcga_lung))]
# 
# saveRDS(tcga_lung, "../../data/13_tcga/tcga-lung-normal-adjacent.rds", compress=FALSE)
```

```{r}
survival = read_excel(params$survival_path, guess_max=1000000, na=c("", "[Not Available]")) %>% 
  filter(type %in% c("LUAD", "LUSC")) %>% 
  select(TCGA_patient_barcode=bcr_patient_barcode, OS_time=OS.time, Status=OS, stage=ajcc_pathologic_tumor_stage, gender, age=age_at_initial_pathologic_diagnosis) 
tcga_expr = readRDS(params$tcga_tpm_path)

common_patients = sort(intersect(colnames(tcga_expr), survival$TCGA_patient_barcode))

survival = survival %>% 
  filter(TCGA_patient_barcode %in% common_patients) %>% 
  arrange(TCGA_patient_barcode)
tcga_expr = tcga_expr[, common_patients]
```

```{r}
gene = "BPIFB1"
tcga_expr[gene, ,drop=FALSE] %>% 
  as_tibble(rownames="gene") %>% 
  pivot_longer(cols=-gene, names_to = "patient", values_to="TPM") %>%
  ggplot(aes(x=gene, y=log10(TPM+1))) + 
  geom_boxplot() + 
  geom_jitter()

```


```{r}
BPIFB1_status = ifelse(log10(tcga_expr[gene, ] + 1) > 2, "high", "low")
BPIFB1_status = tibble(bpifb1_status = BPIFB1_status, TCGA_patient_barcode = names(BPIFB1_status) ,bpifb1 = log10(tcga_expr[gene, ] + 1)) %>%
  inner_join(survival)

fit <- survfit(Surv(OS_time, Status) ~ bpifb1_status, data = BPIFB1_status)

ggsurvplot(fit, data = BPIFB1_status)
```

```{r}
coxph(Surv(OS_time, Status) ~ bpifb1_status + gender + age + stage, data = BPIFB1_status)

```