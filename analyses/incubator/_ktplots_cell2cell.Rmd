---
title: "CPDB interaction plots"
output: html_document
---

```{r, include=FALSE}
library(conflicted)

library(ggplot2)
library(ggraph)
library(dplyr)
conflict_prefer("filter", "dplyr")
conflict_prefer("rename", "dplyr")
library(readr)
library(ggrepel)
library(igraph)
library(readxl)
library(reticulate)
```

```{r, include=FALSE}
sh = import("scanpy_helpers")
COLORS = sapply(names(sh$colors$COLORS), \(x) unlist(sh$colors$COLORS[[x]]), simplify = FALSE, USE.NAMES = TRUE)

zeileis_28 = c(
    "#023fa5",
    "#7d87b9",
    "#bec1d4",
    "#d6bcc0",
    "#bb7784",
    "#8e063b",
    "#4a6fe3",
    "#8595e1",
    "#b5bbe3",
    "#e6afb9",
    "#e07b91",
    "#d33f6a",
    "#11c638",
    "#8dd593",
    "#c6dec7",
    "#ead3c6",
    "#f0b98d",
    "#ef9708",
    "#0fcfc0",
    "#9cded6",
    "#d5eae7",
    "#f3e1eb",
    "#f6c4e1",
    "#f79cd4",
    # these last ones were added:
    '#7f7f7f',
    "#c7c7c7",
    "#1CE6FF",
    "#336600"
)


immune_cells = c(
  "B cell"   ,
  "cDC1"            ,
  "cDC2" ,
  "DC mature"     ,
  "Macrophage"     ,
  "Macrophage FABP4+"  ,
  "Mast cell"     ,
  "Monocyte"       ,
  "Neutrophils"   ,
  "NK cell"      ,
  "pDC"       ,
  "Plasma cell",
  "T cell CD4"       ,
  "T cell CD8"     ,
  "T cell regulatory"
)
```


```{r, include=FALSE}
cpdb_plot = function(cpdb_res, edge_color="log2_fc", edge_color_scale=scale_edge_color_distiller(palette="RdBu", limits=c(-1,1) * max(abs(conn_meta$log2_fc)))) {
  # make edges df
  edges = cpdb_res |>
    mutate( from=sprintf("%s_%s_ligand", cluster_1, source), to=sprintf("%s_%s_receptor", cluster_2, target)) |>
    select(from, to, name="variable", coef, pvalue, fdr, group, log2_fc) |>
    mutate(log2_fc = if_else(is.infinite(log2_fc) & log2_fc < 0, -max(abs(log2_fc[is.finite(log2_fc)])), log2_fc)) |> 
    mutate(log2_fc = if_else(is.infinite(log2_fc) & log2_fc > 0, max(abs(log2_fc[is.finite(log2_fc)])), log2_fc)) |>
    mutate(fdr = if_else(fdr == 0, 1e-255, fdr))
  
  # make nodes df
  nodes_source = cpdb_res |> 
    select(cell_type=cluster_1, gene=source) |>
    mutate(type="ligand") |>
    mutate(name=sprintf("%s_%s_%s", cell_type, gene, type))
  nodes_target = cpdb_res |> 
    select(cell_type=cluster_2, gene=target) |>
    mutate(type="receptor") |>
    mutate(name=sprintf("%s_%s_%s", cell_type, gene, type))
  nodes = bind_rows(nodes_source, nodes_target) |>
    distinct() |>
    select(name, cell_type, gene, type) |>
    filter(name %in% edges$to | name %in% edges$from)

  cell_types = unique(c(cpdb_res$cluster_1, cpdb_res$cluster_2))
  cell_type_lr = unique(paste0(nodes$cell_type, "_", nodes$type))
  
  # construct hierarchy graph for dendrogram
  edges_ct_hierarchy = bind_rows(
    # root
    data.frame(from="root", to=nodes$cell_type),
    nodes |> mutate(to=paste0(cell_type, "_", type)) |> select(from=cell_type, to) |> distinct(),
    nodes |> mutate(from=paste0(cell_type, "_", type), to=name) |> select(from, to)
  )
  nodes_ct_hierarchy = data.frame(name=unique(c(edges_ct_hierarchy$to, edges_ct_hierarchy$from))) |> 
    left_join(nodes, by="name") |> group_by(cell_type) |>  group_modify(function(x, key) { 
      n = nrow(x)
      n1 = floor(n/2)
      n2 = n - 1 - n1
      x$cell_type_label = c(rep(NA, n1), key$cell_type, rep(NA, n2))
      x
    }) |> ungroup() |> select(name, cell_type, gene, type, cell_type_label)
  G_ct =graph_from_data_frame(edges_ct_hierarchy, directed=TRUE, vertices=nodes_ct_hierarchy)


  # info for geom_conn_bundle
  from = match(edges$from, nodes_ct_hierarchy$name)
  to = match(edges$to, nodes_ct_hierarchy$name)
  conn_meta = data.frame(from=nodes_ct_hierarchy[from,]$name, to=nodes_ct_hierarchy[to,]$name) |>
    left_join(edges, by=c("from", "to")) 
  
  # plot using ggraph
  p = ggraph(G_ct, layout="dendrogram", circular=TRUE) + 
    geom_node_point(aes(color=cell_type, shape=type), size=8, stroke=2, fill="white") + 
    geom_conn_bundle(
      data = get_con(from=from, to=to, coef=conn_meta$coef, log2_fc=conn_meta$log2_fc, pvalue=conn_meta$pvalue, group=conn_meta$group, fdr=conn_meta$fdr),
      # aes_string(color=edge_color, width="abs(log2_fc)"),
      aes_string(color=edge_color, width="abs(log10(fdr))"),
      tension=0.4,
      arrow=arrow()) +
    edge_color_scale + 
    scale_edge_width_continuous(range=c(1,5)) + 
    theme_void() + 
    geom_text_repel(aes(x=x, y=y, label=gene), size=5 ) + 
    geom_label_repel(aes(x=x, y=y, nudge_x=1.3*x, nudge_y=1.3*y, label=cell_type_label), xlim=c(-2, 2), size=8, force=3, alpha=.8) + 
    coord_fixed(clip="off") +
    scale_shape_manual(values=c("receptor"=23, "ligand"=19))  +
    scale_color_manual(values=zeileis_28)   +
    theme(legend.position="top")
  p
}

# ggsave("cell2cell.pdf")
```

```{r, include=FALSE}
cpdb_luad_lscc = read_tsv("../../data/30_downstream_analyses/plots_and_comparisons/91_compare_groups/artifacts/luad_lscc_cpdb.tsv")

cpdb_infiltration = read_tsv("../../data/30_downstream_analyses/plots_and_comparisons/91_compare_groups/artifacts/patient_immune_infiltration_cpdb.tsv")
cpdb_infiltration_treatment_condition = read_tsv("../../data/30_downstream_analyses/plots_and_comparisons/91_compare_groups/artifacts/patient_immune_infiltration_treatment_coding_condition_cpdb.tsv")

cpdb_tumor_normal = read_tsv("../../data/30_downstream_analyses/plots_and_comparisons/91_compare_groups/artifacts/tumor_normal_cpdb.tsv")

cytosig = read_tsv("../../data/30_downstream_analyses/plots_and_comparisons/91_compare_groups/artifacts/patient_immune_infiltration_cytosig.tsv")
```

## Explanation of the plots

 * Each dot in the circle marks a ligand (filled circle) or a receptor (outline square). The direction of the interaction (ligant -> receptor) is additionally indicated with arrows
 * The ligands and receptors are colored and organized by cell-type
 * Arrows indicate interactions that are differentially regulated between two conditions. Red arrows mean up-regulated, blue down-regulated. 
 * The thickness of the arrows indicates the confidence (=FDR) that the given interaction is differentially regulated. 
 * Usually, the top 100 differentailly regulated interactions are shown. It is, in most cases, not possible to fit all significantly different interactions into the plot. 

### Early advanced

Comparison between early and advanced tumor stages. Red = upregulated in advanced, blue = upregulated in early. 

```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}
# cpdb_early_advanced |> filter(abs(log2_fc) > 1) |> head(100) |> cpdb_plot()
```

### LUAD LSCC

Comparison of LUAD and LSCC samples. Blue = Upregulated in LUAD, Red = upregulated in LSCC

```{r, fig.width=20, fig.height=12, message=FALSE, warning=FALSE, results=FALSE}
cpdb_luad_lscc |> filter(abs(log2_fc) > 1, fdr < 0.1,  cluster_2 == "Neutrophils") |> cpdb_plot(edge_color = "abs(log10(fdr))", edge_color_scale=scale_edge_color_viridis())
```

```{r, fig.width=14, fig.height=8, message=FALSE, warning=FALSE, results=FALSE}
cpdb_luad_lscc |> filter(abs(log2_fc) > 1, cluster_2 == "B cell") |> filter(fdr < 0.1) |> cpdb_plot()
```

```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}
cpdb_luad_lscc |> filter(abs(log2_fc) > 1) |> mutate(group2 = if_else(log2_fc < 0, "LSCC", "LUAD")) |> group_by(group2) |> 
  filter(row_number() < 30) |> ungroup() |> cpdb_plot()
```

Focus on Neutrophils

```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}
cpdb_luad_lscc |> filter(abs(log2_fc) > 1, fdr < 0.1,  cluster_1 == "Neutrophils" | cluster_2 == "Neutrophils") |> cpdb_plot(edge_color = "abs(log10(fdr))", edge_color_scale=scale_edge_color_viridis())
```




### Infiltration status

Comparison of "infiltration status", i.e. immune desert vs. infiltrated (all three groups). 
Blue = interaction increased in desert, Red = interaction increased in infiltration. 
```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}
# cpdb_infiltration_status |> filter(abs(log2_fc) > 1) |> head(100) |> cpdb_plot()
```

### Infiltration status (only tumor and structural cells)

Same as above, but only focusing on ligands on Tumor, stromal and endothelial cells. 

```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}
# cpdb_infiltration_status |> filter(abs(log2_fc) > 1, cluster_1 %in% c("Tumor cells", "Stromal", "Endothelial cell")) |> head(100) |> cpdb_plot()
```

### Infiltration type (originating from Tumor, stromal, endothelial cells)

Comparison of the four infiltration types. Interactions are colored according to whether they 
are uniquely upregulated in either the immune desert group (grey), the B-cell infiltration group (orange), the Macro/Mono infiltration group (green), or the T-cell infiltration group (blue). 

```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}

cpdb_infiltration |> rename(variable=`...1`) |>
  filter(log2_fc > 1) |>
  # filter(cluster_1 %in% c("Tumor cells", "Stromal", "Endothelial cell"), cluster_2 %in% immune_cells ) |> 
mutate(fdr=p.adjust(pvalue, method="fdr")) |> 
  group_by(group) |> 
  filter(row_number() < 15) |>  
  ungroup() |> 
  cpdb_plot(edge_color="group", edge_color_scale = scale_edge_color_manual(values = COLORS$immune_infiltration))
```

```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}

cpdb_infiltration_treatment_condition |> rename(variable=`...1`) |>
  filter(log2_fc > 1) |>
  # filter(cluster_1 %in% c("Tumor cells", "Stromal", "Endothelial cell"), cluster_2 %in% immune_cells ) |> 
mutate(fdr=p.adjust(pvalue, method="fdr")) |> 
  group_by(group) |> 
  filter(row_number() < 20) |>  
  ungroup() |> 
  cpdb_plot(edge_color="group", edge_color_scale = scale_edge_color_manual(values = COLORS$immune_infiltration))
```

### Tumor vs normal

Differential signalling between tumor and normal adjacent tissue. Blue = up-regulated in normal, red= upregulated in tumor. 
```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}
cpdb_tumor_normal |> filter(abs(log2_fc) > 1) |> 
  # filter(cluster_1 %in% c("Tumor cells", "Stromal", "Endothelial cell")) |> 
  head(75) |>
  # clip log fc for better aesthetics
  mutate(log2_fc = sapply(log2_fc, \(x) if_else(x < 0, max(x, -5), min(x, 5)))) |>
  cpdb_plot()
```


<!-- ## By cell type -->
<!-- ```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE} -->
<!-- cpdb_cell_types |> filter(abs(log2_fc) > 1, group %in% c("Stromal", "Endothelial cell", "Tumor cells"), cluster_2 %in% c("Stromal", "Endothelial cell", "Tumor cells")) |> head(150) |> rename(variable=`...1`) |> mutate(cluster_1=group) |> cpdb_plot(edge_color="group", edge_color_scale=scale_edge_color_brewer(palette="Set2")) -->
<!-- ``` -->

```{r, include=FALSE}
growth_factors = read_csv("../../tables/gene_annotations/genecards_growth_factors.csv", comment = "#")
immune_checkpoints = read_csv("../../tables/gene_annotations/immune_checkpoints.csv", comment="#")
neutro_genes_of_interest = read_excel("../../tables/gene_annotations/neutro_recruitment_chemokines.xlsx")
```

<!-- ## All growth factors (stromal -> tumor) -->
<!-- ```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE} -->
<!-- cpdb_cell_types |> rename(variable=`...1`) |> mutate(cluster_1=group) |> filter(group %in% c("Endothelial cell", "Stromal"), cluster_2 == "Tumor cells", source %in% growth_factors$`Gene Symbol`, log2_fc > 2, fdr < 0.01) |>  -->
<!--   cpdb_plot(edge_color="group", edge_color_scale=scale_edge_color_brewer(palette="Set2")) -->
<!-- ``` -->

<!-- ## All checkpoints (tumor immune) -->
<!-- ```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE} -->
<!-- cpdb_cell_types |> rename(variable=`...1`) |> mutate(cluster_1=group) |> -->
<!--   filter(group %in% c("Tumor cells"), cluster_2 %in% c("T cell CD4", "T cell CD8", "T cell regulatory"), target %in% immune_checkpoints$gene_symbol, log2_fc > 2, fdr < 0.1) |> cpdb_plot() -->
<!-- ``` -->

<!-- ## All checkpoints (LUAD LSCC, tumor immune) -->
<!-- ```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE} -->
<!-- cpdb_luad_lscc |> filter(cluster_1 %in% c("Tumor cells"), target %in% immune_checkpoints$gene_symbol) |>  -->
<!-- mutate(fdr=p.adjust(pvalue, method="fdr")) |> filter(fdr < 0.1) |> cpdb_plot() -->
<!-- ``` -->

## Selected interactions (Neutrophils)
```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}
neutro_goi = c(neutro_genes_of_interest$`TME Ligand`, neutro_genes_of_interest$`(neutrophil) receptor`)

cpdb_luad_lscc |> filter(
  cluster_1 == "Neutrophils" | cluster_2 == "Neutrophils", source %in% neutro_goi | target %in% neutro_goi
)|> 
mutate(fdr=p.adjust(pvalue, method="fdr")) |> filter(fdr < 0.1) |>
  cpdb_plot()

```

## Selected interactions (from cytosig)

Only focusing on interactions also found in the cytosig analysis.
```{r, fig.width=18, fig.height=12, message=FALSE, warning=FALSE, results=FALSE}

selected_cytosig_variables = cytosig |> filter(cell_type %in% c("Tumor cells", "Stromal", "Endothelial cell")) |>
  mutate(fdr = p.adjust(pvalue, method="fdr")) |> filter(fdr < 0.1) |> pull("variable")

cpdb_infiltration |> rename(variable=`...1`) |>
  # filter(log2_fc > 1) |> 
  filter(cluster_1 %in% c("Tumor cells", "Stromal", "Endothelial cell"), source %in% selected_cytosig_variables, cluster_2 %in% immune_cells ) |> 
mutate(fdr=p.adjust(pvalue, method="fdr")) |> filter(fdr < 0.1) |>
  cpdb_plot(edge_color="group", edge_color_scale = scale_edge_color_manual(values = COLORS$immune_infiltration))
```

<!-- ## All checkpoints (infiltration) -->
<!-- ```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE} -->

<!-- cpdb_infiltration |> rename(variable=`...1`) |> -->
<!--   filter(log2_fc > 1) |>  -->
<!--   filter(cluster_1 %in% c("Tumor cells"), target %in% immune_checkpoints$gene_symbol) |>  -->
<!-- mutate(fdr=p.adjust(pvalue, method="fdr")) |> filter(fdr < 0.1) |> -->
<!--   cpdb_plot(edge_color="group", edge_color_scale = scale_edge_color_brewer(palette="Set2")) -->
<!-- ``` -->


<!-- ## All checkpoints (early_advanced) -->
<!-- ```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE} -->
<!-- cpdb_early_advanced |> filter(cluster_1 %in% c("Tumor cells"), target %in% immune_checkpoints$gene_symbol) |>  -->
<!-- mutate(fdr=p.adjust(pvalue, method="fdr")) |> filter(fdr < 0.1) |> cpdb_plot() -->
<!-- ``` -->


