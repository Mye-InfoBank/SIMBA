---
title: "CPDB interaction plots"
output: html_document
---

```{r, include=FALSE}
library(conflicted)

library(ggplot2)
library(ggraph)
library(dplyr)
conflict_prefer("filter", "dplyr")
conflict_prefer("rename", "dplyr")
library(readr)
library(ggrepel)
library(igraph)
library(readxl)
library(reticulate)
```

```{r, include=FALSE}
sh = import("scanpy_helpers")
COLORS = sapply(names(sh$colors$COLORS), \(x) unlist(sh$colors$COLORS[[x]]), simplify = FALSE, USE.NAMES = TRUE)

zeileis_28 = c(
    "#023fa5",
    "#7d87b9",
    "#bec1d4",
    "#d6bcc0",
    "#bb7784",
    "#8e063b",
    "#4a6fe3",
    "#8595e1",
    "#b5bbe3",
    "#e6afb9",
    "#e07b91",
    "#d33f6a",
    "#11c638",
    "#8dd593",
    "#c6dec7",
    "#ead3c6",
    "#f0b98d",
    "#ef9708",
    "#0fcfc0",
    "#9cded6",
    "#d5eae7",
    "#f3e1eb",
    "#f6c4e1",
    "#f79cd4",
    # these last ones were added:
    '#7f7f7f',
    "#c7c7c7",
    "#1CE6FF",
    "#336600"
)


immune_cells = c(
  "B cell"   ,
  "cDC1"            ,
  "cDC2" ,
  "DC mature"     ,
  "Macrophage"     ,
  "Macrophage alveolar"  ,
  "Mast cell"     ,
  "Monocyte"       ,
  "Neutrophils"   ,
  "NK cell"      ,
  "pDC"       ,
  "Plasma cell",
  "T cell CD4"       ,
  "T cell CD8"     ,
  "T cell regulatory"
)
```


```{r, include=FALSE}
cpdb_plot = function(cpdb_res, edge_color="log2_fc", edge_color_scale=scale_edge_color_gradientn(colors=pals::coolwarm(100), limits=c(-1,1) * max(abs(conn_meta[[edge_color]])))) {
  # make edges df
  edges = cpdb_res |>
    mutate( from=sprintf("%s_%s_ligand", cluster_1, source), to=sprintf("%s_%s_receptor", cluster_2, target)) |>
    select(from, to, name="variable", coef, pvalue, fdr, group, log2_fc) |>
    mutate(log2_fc = if_else(is.infinite(log2_fc) & log2_fc < 0, -max(abs(log2_fc[is.finite(log2_fc)])), log2_fc)) |>
    mutate(log2_fc = if_else(is.infinite(log2_fc) & log2_fc > 0, max(abs(log2_fc[is.finite(log2_fc)])), log2_fc)) |>
    mutate(fdr = if_else(fdr == 0, 1e-255, fdr))

  # make nodes df
  nodes_source = cpdb_res |>
    select(cell_type=cluster_1, gene=source) |>
    mutate(type="ligand") |>
    mutate(name=sprintf("%s_%s_%s", cell_type, gene, type))
  nodes_target = cpdb_res |>
    select(cell_type=cluster_2, gene=target) |>
    mutate(type="receptor") |>
    mutate(name=sprintf("%s_%s_%s", cell_type, gene, type))
  nodes = bind_rows(nodes_source, nodes_target) |>
    distinct() |>
    select(name, cell_type, gene, type) |>
    filter(name %in% edges$to | name %in% edges$from)

  cell_types = unique(c(cpdb_res$cluster_1, cpdb_res$cluster_2))
  cell_type_lr = unique(paste0(nodes$cell_type, "_", nodes$type))

  # construct hierarchy graph for dendrogram
  edges_ct_hierarchy = bind_rows(
    # root
    data.frame(from="root", to=nodes$cell_type),
    nodes |> mutate(to=paste0(cell_type, "_", type)) |> select(from=cell_type, to) |> distinct(),
    nodes |> mutate(from=paste0(cell_type, "_", type), to=name) |> select(from, to)
  )
  nodes_ct_hierarchy = data.frame(name=unique(c(edges_ct_hierarchy$to, edges_ct_hierarchy$from))) |>
    left_join(nodes, by="name") |> group_by(cell_type) |>  group_modify(function(x, key) {
      n = nrow(x)
      n1 = floor(n/2)
      n2 = n - 1 - n1
      x$cell_type_label = c(rep(NA, n1), key$cell_type, rep(NA, n2))
      x
    }) |> ungroup() |> select(name, cell_type, gene, type, cell_type_label)
  G_ct =graph_from_data_frame(edges_ct_hierarchy, directed=TRUE, vertices=nodes_ct_hierarchy)


  # info for geom_conn_bundle
  from = match(edges$from, nodes_ct_hierarchy$name)
  to = match(edges$to, nodes_ct_hierarchy$name)
  conn_meta = data.frame(from=nodes_ct_hierarchy[from,]$name, to=nodes_ct_hierarchy[to,]$name) |>
    left_join(edges, by=c("from", "to"))

  # plot using ggraph
  p = ggraph(G_ct, layout="dendrogram", circular=TRUE) +
    geom_node_point(aes(color=cell_type, shape=type), size=8, stroke=2, fill="white") +
    geom_conn_bundle(
      data = get_con(from=from, to=to, coef=conn_meta$coef, log2_fc=conn_meta$log2_fc, pvalue=conn_meta$pvalue, group=conn_meta$group, fdr=conn_meta$fdr),
      aes_string(color=edge_color, width="abs(coef)"),
      # aes_string(color=edge_color, width="abs(log10(fdr))"),
      tension=0.4,
      arrow=arrow()) +
    edge_color_scale +
    scale_edge_width_continuous(range=c(1,5)) +
    theme_void() +
    geom_text_repel(aes(x=x, y=y, label=gene), size=5 ) +
    geom_label_repel(aes(x=x, y=y, nudge_x=1.3*x, nudge_y=1.3*y, label=cell_type_label), xlim=c(-2, 2), size=8, force=3, alpha=.8) +
    coord_fixed(clip="off") +
    scale_shape_manual(values=c("receptor"=23, "ligand"=19))  +
    scale_color_manual(values=zeileis_28)   +
    theme(legend.position="top")
  p
}

# ggsave("cell2cell.pdf")
```

```{r, include=FALSE}
cpdb_luad_lusc = read_tsv("../../data/30_downstream_analyses/plots_and_comparisons/91_compare_groups/artifacts/luad_lusc_cpdb.tsv")
cpdb_infiltration = read_tsv("../../data/30_downstream_analyses/plots_and_comparisons/91_compare_groups/artifacts/patient_immune_infiltration_cpdb.tsv")
cpdb_infiltration_treatment_condition = read_tsv("../../data/30_downstream_analyses/plots_and_comparisons/91_compare_groups/artifacts/patient_immune_infiltration_treatment_coding_cpdb.tsv")
cpdb_infiltration_status = read_tsv("../../data/30_downstream_analyses/plots_and_comparisons/91_compare_groups/artifacts/patient_infiltration_status_cpdb.tsv")
```

## Explanation of the plots

 * Each dot in the circle marks a ligand (filled circle) or a receptor (outline square). The direction of the interaction (ligant -> receptor) is additionally indicated with arrows
 * The ligands and receptors are colored and organized by cell-type
 * Arrows indicate interactions that are differentially regulated between two conditions. Red arrows mean up-regulated, blue down-regulated.
 * The thickness of the arrows indicates the confidence (=FDR) that the given interaction is differentially regulated.
 * Usually, the top 100 differentailly regulated interactions are shown. It is, in most cases, not possible to fit all significantly different interactions into the plot.

### LUAD LUSC

Comparison of LUAD and LUSC samples. Blue = Upregulated in LUAD, Red = upregulated in LUSC


```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}
cpdb_luad_lusc |> mutate(group2 = if_else(log2_fc < 0, "LUSC", "LUAD")) |> group_by(group2) |>
  mutate(coef = sign(coef) * pmin(abs(coef), 0.5)) |> 
  filter(row_number() < 30, fdr < 0.1) |> ungroup() |> cpdb_plot(edge_color="coef")
```

```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}
cpdb_luad_lusc |> mutate(group2 = if_else(log2_fc < 0, "LUSC", "LUAD")) |> 
  filter(cluster_1 == "Tumor cells", cluster_2 %in% immune_cells) |> mutate(fdr = p.adjust(pvalue, method="fdr")) |> group_by(group2) |>
  mutate(coef = sign(coef) * pmin(abs(coef), 0.3)) |> 
  filter(row_number() < 25, fdr < 0.1) |> ungroup() |> cpdb_plot(edge_color="coef")
```

### Infiltration status

Comparison of "infiltration status", i.e. immune desert vs. infiltrated (all three groups).
Blue = interaction increased in desert, Red = interaction increased in infiltration.
```{r, fig.width=22, fig.height=14, message=FALSE, warning=FALSE, results=FALSE}
cpdb_infiltration_status |> mutate(group2 = if_else(coef < 0, "desert", "infiltrated")) |> 
  filter(cluster_1 == "Tumor cells", cluster_2 %in% immune_cells) |> mutate(fdr = p.adjust(pvalue, method="fdr")) |> group_by(group2) |> head(50) |> 
  mutate(coef = sign(coef) * pmin(abs(coef), 0.3)) |> 
  # filter(row_number() < 25, fdr < 0.1) |> ungroup() |>
  cpdb_plot(edge_color="coef")
```
